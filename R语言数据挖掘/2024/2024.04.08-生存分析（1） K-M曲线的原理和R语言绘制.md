>> 做生存分析常用的方式就是绘制KM曲线或者进行Cox分析，**KM曲线常用在描述不同分组生存的差异**。Cox通常用于探索多个协变量对生存时间的影响，**今天我们先学习一下KM曲线的原理和绘制**。

## KM 曲线应用

**Kaplan-Meier（K-M）**曲线是一种用于展示生存分析结果的图形工具，**它显示了在不同时间点上个体生存（或免于事件发生）的概率**，在临床上有很多应用。
- `评估治疗效果`：生存分析可以用于评估不同治疗方法对患者生存时间的影响，以确定哪种治疗方式更有效。
- `预测疾病进展`：生存分析可以用来预测患者的疾病进展时间。这对于制定适当的治疗计划和监控疾病状态非常重要。
- `评估风险因素`：生存分析可以通过考察不同变量对生存的影响，更好地了解这些因素如何影响事件的发生。

## K-M生存曲线特点

- `阶梯状曲线：`K-M曲线是一个阶梯状的曲线，**其中每个台阶代表一个特定时间点**。每个台阶的高度表示在该时间点的生存概率，**也就是在该时间点之前存活的个体比例**。
- `事件发生时跳跃：`K-M曲线在事件发生时会出现跳跃，即曲线下降一个台阶。这表示在该时间点有个体发生了事件，导致存活率下降。
- `右侧截尾：`K-M曲线通常从时间零开始，右侧没有截尾，也就是在研究结束时，所有个体都会发生事件或被观察到。

![K-M生存曲线](https://files.mdnice.com/user/23696/d4f10314-7ce2-41b1-ac72-fa41798e1e12.png)

## K-M生存曲线原理
1、生存时间数据收集：也就是从**某个起始时间点开始，到事件发生（或观察结束）所经过的时间**。这个事件可以是患病、死亡、丢失等。

2、计算生存概率：对于每个时间点，**计算在该时间点之前个体存活的概率**。这个概率可以通过以下步骤计算：
- 在每个观测时间点，计算仍然存活的个体数（N(t)）和事件发生的个体数（D(t)）。
- 计算在该时间点的生存概率：S(t) = (N(t) - D(t)) / N(t-1)，其中N(t-1)是上一个时间点的仍然存活的个体数。

3、构建K-M曲线：根据计算出的生存概率，**在不同时间点上绘制曲线**。K-M曲线是一条逐步下降的阶梯状曲线，每个台阶的高度表示在该时间点的生存概率。

## R语言绘制生存曲线

##### 可以后台回复**“生存曲线”**获得演示数据

#### 数据处理
##### 这里是根据基因表达的中位数进行分组，**后面会更新如果使用最佳cutoff值，以及其原理**。
```r
#包没安装的可以提前安装一下
library(data.table) # 数据读取使用
library(dplyr) #数据处理使用
library(survival) #生存分析使用
library(survminer) #绘制生存曲线

data1 <- fread("~/BioXCG/test_data.csv")
# 数据筛选
single_survival <- data1 %>% 
  dplyr::select(sample,OS,OS.time, "Gene") %>% ## 选择这四列数据
  dplyr::mutate(group = ifelse(data1$Gene > median(data1$Gene),"High","Low")) %>% ## 根据中位数进行分组
  mutate(OS.time=round(OS.time/30,2)) %>% ## 将时间以月份形式展示
  na.omit() %>% arrange(group) ##按照分组进行排序
single_survival$group <- factor(single_survival$group,levels = c("High","Low"))
```

筛选后的数据有四列，第一列是样本名，第二列是生存状态，**1表示事件发生（死亡），0表示事件未发生（存活）**，第三列是生存时间，第四列是类别。

![处理后的数据](https://files.mdnice.com/user/23696/bad6d130-b2ad-4468-a5de-782faca5b62d.png)


#### 绘制生存曲线
```r
sfit <- survfit(Surv(OS.time, OS) ~ group, data = single_survival)
ggsurvplot(sfit,
           pval = TRUE,
           conf.int = F,
           fun = "pct",
           xlab = "Time (Months)",
           palette = c("red", "black"),
           legend.title = ggplot2::element_blank(),
           legend.labs = c("High","Low"),
           break.time.by = 40,
           risk.table = T,
           tables.height = 0.2,
           ggtheme = theme_bw())
```
##### 部分参数解读
- pval = TRUE: 显示每个组之间的统计显著性水平。
- conf.int = F: **表示是否在曲线周围显示置信区间**。
- fun = "pct": 在风险表中显示百分比（即每个时间点上的存活率）。
- break.time.by = 40: 设置x轴的时间刻度间隔为40。
- risk.table = T: **显示风险表，也可以不显示。**
- tables.height = 0.2: 风险表的高度。

![生存曲线](https://files.mdnice.com/user/23696/e00dd13a-94d4-4aec-a132-60202099da0c.png)

##### 这里展示了一下生存曲线的绘制，很多时候绘制的结果可能并没有显著差异（P > 0.05），**这时候就需要一些分组技巧了**，可以有下面几种方式：

- 计算和使用**最佳cutoff值**进行分组
- 绘制**五年或十年**生存曲线
- 绘制**无疾病进展期（PFI）**的曲线
- 筛选**过滤掉一些随访数据较少**的样本
- 将样本分为三组，使用第一组和第三组和绘制K-M曲线。

##### 下次就更新一下这些分组的方式（会尽量参考已发表的论文），以及最佳cutoff的原理。
## 
不知道大家有没有想过：**绘制五年生存曲线时，样本该怎么处理呢**？
- 是直接过滤掉有5年以上随访数据的样本，还是将具有5年以上生存的样本生存状态改成”存活“，生存时间改成5年呢？，可以结合生存曲线的原理来想一下，下次（后天）更新会仔细介绍的。